typedef unsigned int uint ; typedef unsigned short ushort ; typedef unsigned char uchar ; typedef unsigned int uint32 ; typedef unsigned long uint64 ; typedef unsigned long uintp ; typedef uintp pde_t ; struct buf ; struct context ; struct file ; struct inode ; struct pipe ; struct proc ; struct spinlock ; struct stat ; struct superblock ; void binit ( void ) ; struct buf * bread ( uint , uint ) ; void brelse ( struct buf * ) ; void bwrite ( struct buf * ) ; void consoleinit ( void ) ; void cprintf ( char * , ... ) ; void consoleintr ( int ( * ) ( void ) ) ; void panic ( char * ) ; int exec ( char * , char * * ) ; struct file * filealloc ( void ) ; void fileclose ( struct file * ) ; struct file * filedup ( struct file * ) ; void fileinit ( void ) ; int fileread ( struct file * , char * , int n ) ; int filestat ( struct file * , struct stat * ) ; int filewrite ( struct file * , char * , int n ) ; void readsb ( int dev , struct superblock * sb ) ; int dirlink ( struct inode * , char * , uint ) ; struct inode * dirlookup ( struct inode * , char * , uint * ) ; struct inode * ialloc ( uint , short ) ; struct inode * idup ( struct inode * ) ; void iinit ( void ) ; void ilock ( struct inode * ) ; void iput ( struct inode * ) ; void iunlock ( struct inode * ) ; void iunlockput ( struct inode * ) ; void iupdate ( struct inode * ) ; int namecmp ( const char * , const char * ) ; struct inode * namei ( char * ) ; struct inode * nameiparent ( char * , char * ) ; int readi ( struct inode * , char * , uint , uint ) ; void stati ( struct inode * , struct stat * ) ; int writei ( struct inode * , char * , uint , uint ) ; void ideinit ( void ) ; void ideintr ( void ) ; void iderw ( struct buf * ) ; void ioapicenable ( int irq , int cpu ) ; extern uchar ioapicid ; void ioapicinit ( void ) ; char * kalloc ( void ) ; void kfree ( char * ) ; void kinit1 ( void * , void * ) ; void kinit2 ( void * , void * ) ; void kbdintr ( void ) ; int cpunum ( void ) ; extern volatile uint * lapic ; void lapiceoi ( void ) ; void lapicinit ( void ) ; void lapicstartap ( uchar , uint ) ; void microdelay ( int ) ; void initlog ( void ) ; void log_write ( struct buf * ) ; void begin_trans ( ) ; void commit_trans ( ) ; extern int ismp ; int mpbcpu ( void ) ; void mpinit ( void ) ; void mpstartthem ( void ) ; int acpiinit ( void ) ; void picenable ( int ) ; void picinit ( void ) ; int pipealloc ( struct file * * , struct file * * ) ; void pipeclose ( struct pipe * , int ) ; int piperead ( struct pipe * , char * , int ) ; int pipewrite ( struct pipe * , char * , int ) ; struct proc * copyproc ( struct proc * ) ; void exit ( void ) ; int fork ( void ) ; int growproc ( int ) ; int kill ( int ) ; void pinit ( void ) ; void procdump ( void ) ; void scheduler ( void ) ; void sched ( void ) ; void sleep ( void * , struct spinlock * ) ; void userinit ( void ) ; int wait ( void ) ; void wakeup ( void * ) ; void yield ( void ) ; void swtch ( struct context * * , struct context * ) ; void acquire ( struct spinlock * ) ; void getcallerpcs ( void * , uintp * ) ; void getstackpcs ( uintp * , uintp * ) ; int holding ( struct spinlock * ) ; void initlock ( struct spinlock * , char * ) ; void release ( struct spinlock * ) ; void pushcli ( void ) ; void popcli ( void ) ; int memcmp ( const void * , const void * , uint ) ; void * memmove ( void * , const void * , uint ) ; void * memset ( void * , int , uint ) ; char * safestrcpy ( char * , const char * , int ) ; int strlen ( const char * ) ; int strncmp ( const char * , const char * , uint ) ; char * strncpy ( char * , const char * , int ) ; int argint ( int , int * ) ; int argptr ( int , char * * , int ) ; int argstr ( int , char * * ) ; int arguintp ( int , uintp * ) ; int fetchuintp ( uintp , uintp * ) ; int fetchstr ( uintp , char * * ) ; void syscall ( void ) ; void timerinit ( void ) ; void idtinit ( void ) ; extern uint ticks ; void tvinit ( void ) ; extern struct spinlock tickslock ; void uartearlyinit ( void ) ; void uartinit ( void ) ; void uartintr ( void ) ; void uartputc ( int ) ; void seginit ( void ) ; void kvmalloc ( void ) ; void vmenable ( void ) ; pde_t * setupkvm ( void ) ; char * uva2ka ( pde_t * , char * ) ; int allocuvm ( pde_t * , uint , uint ) ; int deallocuvm ( pde_t * , uintp , uintp ) ; void freevm ( pde_t * ) ; void inituvm ( pde_t * , char * , uint ) ; int loaduvm ( pde_t * , char * , struct inode * , uint , uint ) ; pde_t * copyuvm ( pde_t * , uint ) ; void switchuvm ( struct proc * ) ; void switchkvm ( void ) ; int copyout ( pde_t * , uint , void * , uint ) ; void clearpteu ( pde_t * pgdir , char * uva ) ; static inline uchar inb ( ushort port ) { uchar data ; asm volatile ( "in %1,%0" : "=a" ( data ) : "d" ( port ) ) ; return data ; } static inline void insl ( int port , void * addr , int cnt ) { asm volatile ( "cld; rep insl" : "=D" ( addr ) , "=c" ( cnt ) : "d" ( port ) , "0" ( addr ) , "1" ( cnt ) : "memory" , "cc" ) ; } static inline void outb ( ushort port , uchar data ) { asm volatile ( "out %0,%1" : : "a" ( data ) , "d" ( port ) ) ; } static inline void outw ( ushort port , ushort data ) { asm volatile ( "out %0,%1" : : "a" ( data ) , "d" ( port ) ) ; } static inline void outsl ( int port , const void * addr , int cnt ) { asm volatile ( "cld; rep outsl" : "=S" ( addr ) , "=c" ( cnt ) : "d" ( port ) , "0" ( addr ) , "1" ( cnt ) : "cc" ) ; } static inline void stosb ( void * addr , int data , int cnt ) { asm volatile ( "cld; rep stosb" : "=D" ( addr ) , "=c" ( cnt ) : "0" ( addr ) , "1" ( cnt ) , "a" ( data ) : "memory" , "cc" ) ; } static inline void stosl ( void * addr , int data , int cnt ) { asm volatile ( "cld; rep stosl" : "=D" ( addr ) , "=c" ( cnt ) : "0" ( addr ) , "1" ( cnt ) , "a" ( data ) : "memory" , "cc" ) ; } struct segdesc ; static inline void lgdt ( struct segdesc * p , int size ) { volatile ushort pd [ 5 ] ; pd [ 0 ] = size - 1 ; pd [ 1 ] = ( uintp ) p ; pd [ 2 ] = ( uintp ) p >> 16 ; pd [ 3 ] = ( uintp ) p >> 32 ; pd [ 4 ] = ( uintp ) p >> 48 ; asm volatile ( "lgdt (%0)" : : "r" ( pd ) ) ; } struct gatedesc ; static inline void lidt ( struct gatedesc * p , int size ) { volatile ushort pd [ 5 ] ; pd [ 0 ] = size - 1 ; pd [ 1 ] = ( uintp ) p ; pd [ 2 ] = ( uintp ) p >> 16 ; pd [ 3 ] = ( uintp ) p >> 32 ; pd [ 4 ] = ( uintp ) p >> 48 ; asm volatile ( "lidt (%0)" : : "r" ( pd ) ) ; } static inline void ltr ( ushort sel ) { asm volatile ( "ltr %0" : : "r" ( sel ) ) ; } static inline uintp readeflags ( void ) { uintp eflags ; asm volatile ( "pushf; pop %0" : "=r" ( eflags ) ) ; return eflags ; } static inline void loadgs ( ushort v ) { asm volatile ( "movw %0, %%gs" : : "r" ( v ) ) ; } static inline void cli ( void ) { asm volatile ( "cli" ) ; } static inline void sti ( void ) { asm volatile ( "sti" ) ; } static inline void hlt ( void ) { asm volatile ( "hlt" ) ; } static inline uint xchg ( volatile uint * addr , uintp newval ) { uint result ; asm volatile ( "lock; xchgl %0, %1" : "+m" ( * addr ) , "=a" ( result ) : "1" ( newval ) : "cc" ) ; return result ; } static inline uintp rcr2 ( void ) { uintp val ; asm volatile ( "mov %%cr2,%0" : "=r" ( val ) ) ; return val ; } static inline void lcr3 ( uintp val ) { asm volatile ( "mov %0,%%cr3" : : "r" ( val ) ) ; } struct trapframe { uint64 eax ; uint64 rbx ; uint64 rcx ; uint64 rdx ; uint64 rbp ; uint64 rsi ; uint64 rdi ; uint64 r8 ; uint64 r9 ; uint64 r10 ; uint64 r11 ; uint64 r12 ; uint64 r13 ; uint64 r14 ; uint64 r15 ; uint64 trapno ; uint64 err ; uint64 eip ; uint64 cs ; uint64 eflags ; uint64 esp ; uint64 ds ; } ; static inline uintp v2p ( void * a ) { return ( ( uintp ) ( a ) ) - ( ( uintp ) 0xFFFFFFFF80000000 ) ; } static inline void * p2v ( uintp a ) { return ( void * ) ( ( a ) + ( ( uintp ) 0xFFFFFFFF80000000 ) ) ; } struct segdesc { uint lim_15_0 : 16 ; uint base_15_0 : 16 ; uint base_23_16 : 8 ; uint type : 4 ; uint s : 1 ; uint dpl : 2 ; uint p : 1 ; uint lim_19_16 : 4 ; uint avl : 1 ; uint rsv1 : 1 ; uint db : 1 ; uint g : 1 ; uint base_31_24 : 8 ; } ; typedef uintp pte_t ; struct taskstate { uint link ; uint esp0 ; ushort ss0 ; ushort padding1 ; uint * esp1 ; ushort ss1 ; ushort padding2 ; uint * esp2 ; ushort ss2 ; ushort padding3 ; void * cr3 ; uint * eip ; uint eflags ; uint eax ; uint ecx ; uint edx ; uint ebx ; uint * esp ; uint * ebp ; uint esi ; uint edi ; ushort es ; ushort padding4 ; ushort cs ; ushort padding5 ; ushort ss ; ushort padding6 ; ushort ds ; ushort padding7 ; ushort fs ; ushort padding8 ; ushort gs ; ushort padding9 ; ushort ldt ; ushort padding10 ; ushort t ; ushort iomb ; } ; struct gatedesc { uint off_15_0 : 16 ; uint cs : 16 ; uint args : 5 ; uint rsv1 : 3 ; uint type : 4 ; uint s : 1 ; uint dpl : 2 ; uint p : 1 ; uint off_31_16 : 16 ; } ; struct cpu { uchar id ; uchar apicid ; struct context * scheduler ; struct taskstate ts ; struct segdesc gdt [ 7 ] ; volatile uint started ; int ncli ; int intena ; void * local ; } ; extern struct cpu cpus [ 8 ] ; extern int ncpu ; extern __thread struct cpu * cpu ; extern __thread struct proc * proc ; struct context { uintp r15 ; uintp r14 ; uintp r13 ; uintp r12 ; uintp r11 ; uintp rbx ; uintp ebp ; uintp eip ; } ; enum procstate { UNUSED , EMBRYO , SLEEPING , RUNNABLE , RUNNING , ZOMBIE } ; struct proc { uintp sz ; pde_t * pgdir ; char * kstack ; enum procstate state ; volatile int pid ; struct proc * parent ; struct trapframe * tf ; struct context * context ; void * chan ; int killed ; struct file * ofile [ 16 ] ; struct inode * cwd ; char name [ 16 ] ; } ; struct elfhdr { uint magic ; uchar elf [ 12 ] ; ushort type ; ushort machine ; uint version ; uintp entry ; uintp phoff ; uintp shoff ; uint flags ; ushort ehsize ; ushort phentsize ; ushort phnum ; ushort shentsize ; ushort shnum ; ushort shstrndx ; } ; struct proghdr { uint32 type ; uint32 flags ; uint64 off ; uint64 vaddr ; uint64 paddr ; uint64 filesz ; uint64 memsz ; uint64 align ; } ; __thread struct cpu * cpu ; __thread struct proc * proc ; static pde_t * kpml4 ; static pde_t * kpdpt ; static pde_t * iopgdir ; static pde_t * kpgdir0 ; static pde_t * kpgdir1 ; void wrmsr ( uint msr , uint64 val ) ; void tvinit ( void ) { } void idtinit ( void ) { } static void mkgate ( uint * idt , uint n , void * kva , uint pl , uint trap ) { uint64 addr = ( uint64 ) kva ; n *= 4 ; trap = trap ? 0x8F00 : 0x8E00 ; idt [ n + 0 ] = ( addr & 0xFFFF ) | ( ( 1 << 3 ) << 16 ) ; idt [ n + 1 ] = ( addr & 0xFFFF0000 ) | trap | ( ( pl & 3 ) << 13 ) ; idt [ n + 2 ] = addr >> 32 ; idt [ n + 3 ] = 0 ; } static void tss_set_rsp ( uint * tss , uint n , uint64 rsp ) { tss [ n * 2 + 1 ] = rsp ; tss [ n * 2 + 2 ] = rsp >> 32 ; } static void tss_set_ist ( uint * tss , uint n , uint64 ist ) { tss [ n * 2 + 7 ] = ist ; tss [ n * 2 + 8 ] = ist >> 32 ; } extern void * vectors [ ] ; void seginit ( void ) { uint64 * gdt ; uint * tss ; uint64 addr ; void * local ; struct cpu * c ; uint * idt = ( uint * ) kalloc ( ) ; int n ; memset ( idt , 0 , 4096 ) ; for ( n = 0 ; n < 256 ; n ++ ) mkgate ( idt , n , vectors [ n ] , 0 , 0 ) ; mkgate ( idt , 64 , vectors [ 64 ] , 3 , 1 ) ; lidt ( ( void * ) idt , 4096 ) ; local = kalloc ( ) ; memset ( local , 0 , 4096 ) ; gdt = ( uint64 * ) local ; tss = ( uint * ) ( ( ( char * ) local ) + 1024 ) ; tss [ 16 ] = 0x00680000 ; wrmsr ( 0xC0000100 , ( ( uint64 ) local ) + ( 4096 / 2 ) ) ; c = & cpus [ cpunum ( ) ] ; c -> local = local ; cpu = c ; proc = 0 ; addr = ( uint64 ) tss ; gdt [ 0 ] = 0x0000000000000000 ; gdt [ 1 ] = 0x0020980000000000 ; gdt [ 4 ] = 0x0020F80000000000 ; gdt [ 2 ] = 0x0000920000000000 ; gdt [ 3 ] = 0x0000000000000000 ; gdt [ 5 ] = 0x0000F20000000000 ; gdt [ 6 + 0 ] = ( 0x0067 ) | ( ( addr & 0xFFFFFF ) << 16 ) | ( 0x00E9LL << 40 ) | ( ( ( addr >> 24 ) & 0xFF ) << 56 ) ; gdt [ 6 + 1 ] = ( addr >> 32 ) ; lgdt ( ( void * ) gdt , 8 * sizeof ( uint64 ) ) ; ltr ( 6 << 3 ) ; } pde_t * setupkvm ( void ) { pde_t * pml4 = ( pde_t * ) kalloc ( ) ; pde_t * pdpt = ( pde_t * ) kalloc ( ) ; pde_t * pgdir = ( pde_t * ) kalloc ( ) ; memset ( pml4 , 0 , 4096 ) ; memset ( pdpt , 0 , 4096 ) ; memset ( pgdir , 0 , 4096 ) ; pml4 [ 511 ] = v2p ( kpdpt ) | 0x001 | 0x002 | 0x004 ; pml4 [ 0 ] = v2p ( pdpt ) | 0x001 | 0x002 | 0x004 ; pdpt [ 0 ] = v2p ( pgdir ) | 0x001 | 0x002 | 0x004 ; pgdir [ 511 ] = ( ( uintp ) pml4 ) | 0x001 ; pgdir [ 510 ] = ( ( uintp ) pdpt ) | 0x001 ; return pgdir ; } void kvmalloc ( void ) { int n ; kpml4 = ( pde_t * ) kalloc ( ) ; kpdpt = ( pde_t * ) kalloc ( ) ; kpgdir0 = ( pde_t * ) kalloc ( ) ; kpgdir1 = ( pde_t * ) kalloc ( ) ; iopgdir = ( pde_t * ) kalloc ( ) ; memset ( kpml4 , 0 , 4096 ) ; memset ( kpdpt , 0 , 4096 ) ; memset ( iopgdir , 0 , 4096 ) ; kpml4 [ 511 ] = v2p ( kpdpt ) | 0x001 | 0x002 ; kpdpt [ 511 ] = v2p ( kpgdir1 ) | 0x001 | 0x002 ; kpdpt [ 510 ] = v2p ( kpgdir0 ) | 0x001 | 0x002 ; kpdpt [ 509 ] = v2p ( iopgdir ) | 0x001 | 0x002 ; for ( n = 0 ; n < 512 ; n ++ ) { kpgdir0 [ n ] = ( n << 21 ) | 0x080 | 0x001 | 0x002 ; kpgdir1 [ n ] = ( ( n + 512 ) << 21 ) | 0x080 | 0x001 | 0x002 ; } for ( n = 0 ; n < 16 ; n ++ ) iopgdir [ n ] = ( 0xFE000000 + ( n << 21 ) ) | 0x080 | 0x001 | 0x002 | 0x008 | 0x010 ; switchkvm ( ) ; } void switchkvm ( void ) { lcr3 ( v2p ( kpml4 ) ) ; } void switchuvm ( struct proc * p ) { void * pml4 ; uint * tss ; pushcli ( ) ; if ( p -> pgdir == 0 ) panic ( "switchuvm: no pgdir" ) ; tss = ( uint * ) ( ( ( char * ) cpu -> local ) + 1024 ) ; tss_set_rsp ( tss , 0 , ( uintp ) proc -> kstack + 4096 ) ; pml4 = ( void * ) ( ( uintp ) ( p -> pgdir [ 511 ] ) & ~ 0xFFF ) ; lcr3 ( v2p ( pml4 ) ) ; popcli ( ) ; }